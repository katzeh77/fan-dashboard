<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ESP32 LED Dashboard</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-900 text-gray-100 min-h-screen flex flex-col items-center">
  <header class="py-4 text-center">
    <h1 class="text-3xl font-bold text-blue-400">ESP32 LED Controller Dashboard</h1>
    <p class="text-gray-400 text-sm">Monitor & Kontrol LED Aquarium</p>
  </header>

  <main class="w-full max-w-6xl p-4">
    <!-- ESP32 Connection -->
    <div class="bg-gray-800 rounded-2xl p-4 mb-6 shadow-lg">
      <h2 class="text-xl font-semibold mb-2">Koneksi ke ESP32</h2>
      <div class="flex items-center space-x-2">
        <input id="espIp" type="text" placeholder="Masukkan IP ESP32 (contoh: 192.168.1.120)" class="w-full px-3 py-2 rounded-lg text-gray-900" />
        <button onclick="connectESP()" class="bg-blue-600 hover:bg-blue-700 px-4 py-2 rounded-lg font-semibold">Hubungkan</button>
      </div>
      <p id="connStatus" class="text-sm mt-2 text-gray-400">Belum terhubung</p>
    </div>

    <!-- Mode Control -->
    <div class="bg-gray-800 rounded-2xl p-4 mb-6 shadow-lg">
      <h2 class="text-xl font-semibold mb-2">Mode Kontrol</h2>
      <div class="flex space-x-3">
        <button onclick="setMode('manual')" class="bg-green-600 hover:bg-green-700 px-4 py-2 rounded-lg font-semibold">Mode Manual</button>
        <button onclick="setMode('autoset')" class="bg-yellow-600 hover:bg-yellow-700 px-4 py-2 rounded-lg font-semibold">Setup Otomatis</button>
        <button onclick="startAuto()" class="bg-blue-600 hover:bg-blue-700 px-4 py-2 rounded-lg font-semibold">Mulai Otomatis</button>
        <button onclick="stopAuto()" class="bg-red-600 hover:bg-red-700 px-4 py-2 rounded-lg font-semibold">Stop</button>
      </div>
    </div>

    <!-- Manual LED Control -->
    <div class="bg-gray-800 rounded-2xl p-4 mb-6 shadow-lg">
      <h2 class="text-xl font-semibold mb-3">Kontrol LED Manual</h2>
      <div id="ledControls" class="grid grid-cols-2 md:grid-cols-4 gap-4">
        <!-- sliders will be added here dynamically -->
      </div>
    </div>

    <!-- Auto Schedule Table -->
    <div class="bg-gray-800 rounded-2xl p-4 mb-6 shadow-lg overflow-x-auto">
      <h2 class="text-xl font-semibold mb-3">Jadwal Otomatis (07:00 - 16:00 per ½ jam)</h2>
      <form id="scheduleForm">
        <table class="border border-gray-700 w-full text-center text-sm">
          <thead id="theadRow" class="bg-gray-700"></thead>
          <tbody id="scheduleTable"></tbody>
        </table>
        <div class="text-right mt-4">
          <button type="button" onclick="saveSchedule()" class="bg-blue-600 hover:bg-blue-700 px-4 py-2 rounded-lg font-semibold">Simpan Jadwal</button>
        </div>
      </form>
    </div>

    <!-- Status Info -->
    <div class="bg-gray-800 rounded-2xl p-4 shadow-lg text-sm text-gray-300">
      <p><b>Waktu Sekarang:</b> <span id="clock">--:--:--</span></p>
      <p><b>Status Suhu:</b> <span id="tempStatus">Tidak ada data</span></p>
    </div>
  </main>

  <footer class="py-4 text-gray-500 text-xs text-center">
    © 2025 ESP32 LED Controller by KatzeH
  </footer>

  <script>
    let espIP = "";
    const slotCount = 19;
    const startHour = 7;

    function connectESP() {
      espIP = document.getElementById("espIp").value.trim();
      if (!espIP) return alert("Masukkan IP ESP32!");
      document.getElementById("connStatus").innerText = "Terhubung ke http://" + espIP;
      loadSchedule();
      initSliders();
    }

    function api(path, method="GET", body=null) {
      if (!espIP) return alert("Belum terhubung ke ESP32!");
      return fetch(`http://${espIP}${path}`, {
        method,
        headers: { "Content-Type": "application/x-www-form-urlencoded" },
        body
      });
    }

    function setMode(mode) {
      api("/setMode", "POST", "mode=" + mode).then(() => alert("Mode diubah ke " + mode));
    }
    function startAuto() {
      api("/startAuto", "POST").then(() => alert("Mode otomatis dimulai"));
    }
    function stopAuto() {
      api("/stopAuto", "POST").then(() => alert("Dihentikan"));
    }

    // ==== Manual LED control ====
    function initSliders() {
      const container = document.getElementById("ledControls");
      container.innerHTML = "";
      for (let i = 1; i <= 8; i++) {
        const div = document.createElement("div");
        div.className = "bg-gray-700 p-3 rounded-xl";
        div.innerHTML = `
          <h3 class='font-semibold mb-2'>LED ${i}</h3>
          <input type='range' min='0' max='255' value='0' id='led${i}' class='w-full accent-blue-500'
            oninput='updateLED(${i}, this.value)'>
          <p class='text-xs mt-1'>Brightness: <span id='val${i}'>0</span></p>`;
        container.appendChild(div);
      }
    }

    function updateLED(index, val) {
      document.getElementById("val"+index).innerText = val;
      api(`/led/${index}`, "POST", val);
    }

    // ==== Schedule Table ====
    function loadSchedule() {
      const thead = document.getElementById("theadRow");
      const tbody = document.getElementById("scheduleTable");
      thead.innerHTML = "<tr><th class='p-2'>LED\\Jam</th></tr>";
      let headerRow = thead.querySelector("tr");
      for (let s = 0; s < slotCount; s++) {
        const hour = startHour + Math.floor(s / 2);
        const min = s % 2 ? "30" : "00";
        const th = document.createElement("th");
        th.className = "p-2";
        th.innerText = `${hour}:${min}`;
        headerRow.appendChild(th);
      }

      tbody.innerHTML = "";
      for (let ch = 0; ch < 8; ch++) {
        const tr = document.createElement("tr");
        tr.innerHTML = `<td class='p-2 font-semibold bg-gray-700'>LED ${ch + 1}</td>`;
        for (let s = 0; s < slotCount; s++) {
          const td = document.createElement("td");
          td.className = "p-1";
          td.innerHTML = `<input name='s_${ch}_${s}' type='number' min='0' max='255' value='0' class='w-16 text-center text-gray-900 rounded'>`;
          tr.appendChild(td);
        }
        tbody.appendChild(tr);
      }
    }

    function saveSchedule() {
      const formData = new FormData(document.getElementById("scheduleForm"));
      const params = new URLSearchParams(formData).toString();
      api("/saveSchedule", "POST", params)
        .then(() => alert("Jadwal disimpan ke ESP32"))
        .catch(() => alert("Gagal simpan jadwal"));
    }

    // ==== Clock ====
    setInterval(() => {
      const d = new Date();
      document.getElementById("clock").innerText = d.toLocaleTimeString();
    }, 1000);
  </script>
</body>
</html>
