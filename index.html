<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>LED Aquarium Controller</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
<script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
/* STYLE: tetap mengikuti tampilan yang sebelumnya kamu setujui */
*{box-sizing:border-box}
body{
  margin:0;
  font-family:'Inter',sans-serif;
  background:url('https://images.unsplash.com/photo-1507525428034-b723cf961d3e?auto=format&fit=crop&w=1350&q=80') no-repeat center center fixed;
  background-size:cover;
  display:flex;
  flex-direction:column;
  align-items:center;
  min-height:100vh;
  padding:20px;
  color:#fff;
}
h1{ margin:10px 0 5px; font-size:28px; text-align:center; text-shadow:2px 2px 6px rgba(0,0,0,0.7); }
#status{ font-size:14px; color:#0f0; margin-bottom:10px; text-shadow:1px 1px 3px rgba(0,0,0,0.5); }
.dashboard{
  background:rgba(255,255,255,0.1);
  backdrop-filter:blur(15px);
  border-radius:20px;
  padding:20px;
  width:100%;
  max-width:460px;
  box-shadow:0 8px 24px rgba(0,0,0,0.4);
}
.temp-container{ display:flex; justify-content:space-around; margin-bottom:12px; flex-wrap:wrap; }
.temp-card{
  background:rgba(255,255,255,0.15);
  border-radius:12px; padding:12px 16px; text-align:center; min-width:110px; margin:5px;
  box-shadow:0 4px 10px rgba(0,0,0,0.3); transition:background 0.3s;
}
.temp-value{ font-size:22px; font-weight:600; margin-top:6px; }
.slider-container{ margin:12px 0; text-align:left; }
.slider-container label{ display:block; font-size:15px; font-weight:600; margin-bottom:6px; color:#fff; text-shadow:1px 1px 2px rgba(0,0,0,0.6); }
input[type=range]{ -webkit-appearance:none; width:100%; height:12px; border-radius:6px; background:rgba(255,255,255,0.3); outline:none; }
input[type=range]::-webkit-slider-thumb{ -webkit-appearance:none; width:22px; height:22px; border-radius:50%; background:#fff; border:2px solid #007bff; cursor:pointer; }
input[type=number]{ width:60px; border:none; border-radius:8px; text-align:center; padding:6px; background:rgba(255,255,255,0.2); color:#fff; }
#alert-box{ display:none; background:rgba(255,0,0,0.4); padding:10px; margin:8px 0; border-radius:10px; text-align:center; font-weight:600; }
#batas-container{ background:rgba(255,255,255,0.15); border-radius:12px; padding:12px; margin-top:10px; box-shadow:0 4px 10px rgba(0,0,0,0.3); }
button{ background:#007bff; color:#fff; border:none; border-radius:8px; padding:6px 14px; cursor:pointer; font-weight:600; }
button:hover{ background:#3399ff }
#chart-container{ margin-top:14px; background:rgba(255,255,255,0.1); padding:12px; border-radius:12px; box-shadow:0 4px 10px rgba(0,0,0,0.3); }
.mode-select{ margin-bottom:10px; text-align:center; }
#auto-container{ background:rgba(255,255,255,0.12); border-radius:12px; padding:12px; margin-top:12px; display:none; box-shadow:0 4px 10px rgba(0,0,0,0.3); max-height:300px; overflow:auto; }
#clock{ text-align:center; font-size:18px; font-weight:600; margin-bottom:8px; text-shadow:1px 1px 2px rgba(0,0,0,0.6); }
.schedule-table{ width:100%; border-collapse:collapse; color:#fff; font-size:14px; white-space:nowrap; }
.schedule-table th,.schedule-table td{ border-bottom:1px solid rgba(255,255,255,0.18); padding:6px; text-align:center; }
.save-row{ display:flex; gap:8px; margin-top:8px; }
@media (max-width:768px){
  .dashboard{width:100%; padding:16px}
  .schedule-table{ font-size:12px }
  input[type=range]{ width:90% }
  canvas{ width:100%!important; height:auto!important }
}
</style>
</head>
<body>
<h1>LED Aquarium Controller</h1>
<div id="status">üîå Menghubungkan ke MQTT...</div>

<div class="dashboard">
  <div class="mode-select">
    <label for="modeSelect" style="font-weight:600;">Mode:</label>
    <select id="modeSelect">
      <option value="manual">Manual</option>
      <option value="auto">Otomatis</option>
    </select>
  </div>

  <div class="temp-container">
    <div class="temp-card">Atas<br><span id="temp1" class="temp-value">-- ¬∞C</span></div>
    <div class="temp-card">Bawah<br><span id="temp2" class="temp-value">-- ¬∞C</span></div>
  </div>

  <div id="alert-box"></div>

  <div id="led-controls"></div>

  <div id="auto-container">
    <div id="clock">--:--:--</div>
    <h3 style="text-align:center;margin-bottom:8px;">Jadwal Intensitas Otomatis (07:00‚Äì16:00)</h3>
    <div style="overflow-x:auto;">
      <table class="schedule-table" id="scheduleTable">
        <thead>
          <tr><th>Waktu</th><th>RB</th><th>B</th><th>V</th><th>R</th><th>G</th><th>W</th><th>S</th><th>F</th></tr>
        </thead>
        <tbody id="scheduleBody"></tbody>
      </table>
    </div>

    <div class="save-row">
      <button id="saveSchedule" style="flex:1;">Save Schedule (local + esp)</button>
      <button id="startAuto" style="flex:1;">‚ñ∂Ô∏è Start Otomatis</button>
    </div>
  </div>

  <div id="batas-container">
    <h3>Batas Suhu Maksimum</h3>
    <input type="number" id="batasSuhu" min="30" max="90" value="50"> ¬∞C
    <button id="setBatas">Simpan</button>
    <div id="batas-info" style="margin-top:8px;color:#ddd;font-size:14px;"></div>
  </div>

  <div id="chart-container">
    <h3 style="text-align:center;margin-bottom:8px;">Grafik Suhu Real-Time</h3>
    <canvas id="tempChart" width="400" height="180"></canvas>
  </div>
</div>

<script>
/* ========== Konfigurasi MQTT ========== */
const brokerUrl = 'wss://broker.emqx.io:8084/mqtt'; // ganti jika perlu
const client = mqtt.connect(brokerUrl, { clientId: 'dash_' + Math.random().toString(16).substr(2,8), clean: true });
const ledNames = ["Royal Blue","Blue","Violet","Red","Green","White","Sump","Fan"];
const scheduleSlots = []; // will hold 'HH:MM' strings
for(let h=7; h<=16; h++){
  scheduleSlots.push(`${String(h).padStart(2,'0')}:00`);
  if(h<16) scheduleSlots.push(`${String(h).padStart(2,'0')}:30`);
}
const SLOT_COUNT = scheduleSlots.length; // 20

/* ========== Build UI (manual sliders + schedule table) ========== */
const ledControls = document.getElementById('led-controls');
ledNames.forEach((name, i) => {
  const idx = i+1;
  const div = document.createElement('div');
  div.className = 'slider-container';
  div.innerHTML = `<label>${name} <input type="number" id="led${idx}-num" min="0" max="100" value="0">%</label>
                   <input type="range" id="led${idx}" min="0" max="100" value="0">`;
  ledControls.appendChild(div);
});

// schedule table
const scheduleBody = document.getElementById('scheduleBody');
for (const t of scheduleSlots) {
  const tr = document.createElement('tr');
  let html = `<td>${t}</td>`;
  for (let c=1;c<=8;c++){
    html += `<td><input data-time="${t}" data-led="${c}" class="sched-inp" type="number" min="0" max="100" value="0" style="width:60px;text-align:center;"></td>`;
  }
  tr.innerHTML = html;
  scheduleBody.appendChild(tr);
}

/* ========== LocalStorage keys ========== */
const LS_SCHEDULE = 'aquarium_schedule_v1';
const LS_MODE = 'aquarium_mode_v1';
const LS_BATAS = 'aquarium_batas_v1';

/* ========== Utilities ========== */
function slotIndexFromTimeLabel(label){ return scheduleSlots.indexOf(label); } // 0..19
function toPayloadPercent(uiVal){ return Math.round(uiVal * 2.55); } // 0-100 -> 0-255

/* ========== Clock in auto container ========== */
function updateClock(){
  const now = new Date();
  const t = now.toLocaleTimeString('id-ID',{hour12:false});
  document.getElementById('clock').textContent = t;
}
setInterval(updateClock, 1000);
updateClock();

/* ========== Chart setup (Chart.js) ========== */
const ctx = document.getElementById('tempChart').getContext('2d');
const labels = [], data1 = [], data2 = [];
const tempChart = new Chart(ctx, {
  type: 'line',
  data: { labels, datasets: [
    { label:'Atas', data: data1, borderColor: 'rgba(255,99,132,1)', tension:0.3, fill:false },
    { label:'Bawah', data: data2, borderColor: 'rgba(54,162,235,1)', tension:0.3, fill:false }
  ]},
  options: { scales:{ y:{ min: 15, max: 80 } }, plugins:{legend:{labels:{color:'#fff'}}} }
});
function pushChart(a,b){
  const now = new Date().toLocaleTimeString();
  labels.push(now); data1.push(a); data2.push(b);
  if(labels.length>60){ labels.shift(); data1.shift(); data2.shift(); }
  tempChart.update();
}

/* ========== MQTT events ========== */
client.on('connect', ()=> {
  document.getElementById('status').innerText = '‚úÖ Terhubung ke broker MQTT';
  document.getElementById('status').style.color = '#0f0';
  // subscribe essential topics
  for(let i=1;i<=8;i++) client.subscribe('led/'+i);
  client.subscribe('suhu/ntc1'); client.subscribe('suhu/ntc2');
  client.subscribe('status/suhu'); client.subscribe('status/batasSuhu');
  client.subscribe('auto/ack'); // optional ack topic
  // after connect, send local schedule & mode to ESP so it has latest copy
  loadLocalAndSyncToESP();
});
client.on('reconnect', ()=>{ document.getElementById('status').innerText = '‚ôªÔ∏è Menghubungkan ulang...'; document.getElementById('status').style.color='#ff0'; });
client.on('offline', ()=>{ document.getElementById('status').innerText = '‚ùå Terputus dari MQTT'; document.getElementById('status').style.color='#f00'; });

client.on('message', (topic, message) => {
  const msg = message.toString();
  if(topic.startsWith('led/')){
    const idx = parseInt(topic.split('/')[1]);
    const perc = Math.round(parseInt(msg)/255*100);
    const s = document.getElementById('led'+idx);
    const n = document.getElementById('led'+idx+'-num');
    if(s) s.value = perc;
    if(n) n.value = perc;
  }
  if(topic === 'suhu/ntc1'){ pushChart(parseFloat(msg), null); document.getElementById('temp1').innerText = parseFloat(msg).toFixed(1)+' ¬∞C'; }
  if(topic === 'suhu/ntc2'){ pushChart(null, parseFloat(msg)); document.getElementById('temp2').innerText = parseFloat(msg).toFixed(1)+' ¬∞C'; }
  if(topic === 'status/suhu'){ // show alert if TINGGI
    const box = document.getElementById('alert-box');
    if(msg.startsWith('TINGGI')){ box.style.display='block'; box.innerHTML = `‚ö†Ô∏è ${msg}`; }
    else box.style.display='none';
  }
  if(topic === 'status/batasSuhu'){
    document.getElementById('batasSuhu').value = parseFloat(msg).toFixed(1);
    document.getElementById('batas-info').innerText = 'Batas suhu saat ini: '+msg+' ¬∞C';
  }
});

/* ========== Manual slider handlers (publish only in manual mode) ========== */
for(let i=1;i<=8;i++){
  const s = document.getElementById('led'+i);
  const n = document.getElementById('led'+i+'-num');
  s.addEventListener('input', ()=>{ n.value = s.value; if(modeIsManual()){ client.publish('led/'+i, String(toPayloadPercent(s.value))); }});
  n.addEventListener('change', ()=>{
    let v = parseInt(n.value); if(isNaN(v)) v = 0; v = Math.max(0, Math.min(100, v));
    n.value = v; s.value = v;
    if(modeIsManual()) client.publish('led/'+i, String(toPayloadPercent(v)));
  });
}
function modeIsManual(){ return document.getElementById('modeSelect').value === 'manual'; }

/* ========== Batas suhu set ========= */
document.getElementById('setBatas').addEventListener('click', ()=> {
  const val = parseFloat(document.getElementById('batasSuhu').value);
  if(isNaN(val) || val < 30 || val > 90){ alert('Masukkan nilai 30‚Äì90 ¬∞C'); return; }
  client.publish('set/batasSuhu', String(val));
  // also persist locally
  localStorage.setItem(LS_BATAS, String(val));
  alert('Batas suhu dikirim dan disimpan (lokal).');
});

/* ========== Schedule edit handlers (save locally on change) ========== */
document.querySelectorAll('.sched-inp').forEach(inp=>{
  inp.addEventListener('change', ()=>{
    let v = parseInt(inp.value); if(isNaN(v)) v = 0; v = Math.max(0,Math.min(100,v)); inp.value = v;
    saveScheduleToLocal(); // save local quickly
  });
});

/* ========== Save Schedule (local + send to ESP to save EEPROM) ========== */
document.getElementById('saveSchedule').addEventListener('click', ()=>{
  saveScheduleToLocal();
  // publish all cells to ESP using auto/set/<HH:MM>/<led> then auto/save
  publishFullScheduleToESP();
  alert('Jadwal dikirim ke ESP dan disimpan (EEPROM) ‚Äî tunggu beberapa detik.');
});

/* ========== Start Auto ========== */
document.getElementById('startAuto').addEventListener('click', ()=>{
  client.publish('auto/start', '1');
  alert('Perintah Start Otomatis dikirim.');
});

/* ========== Publish entire schedule to ESP (auto/set per cell) ========== */
function publishFullScheduleToESP(){
  // gather table inputs
  const all = [];
  const inputs = document.querySelectorAll('.sched-inp');
  inputs.forEach(inp => {
    const t = inp.getAttribute('data-time');
    const led = inp.getAttribute('data-led');
    const v = parseInt(inp.value) || 0;
    const payload = toPayloadPercent(v);
    client.publish(`auto/set/${t}/${led}`, String(payload));
  });
  // after sending all cells, tell ESP to persist
  setTimeout(()=> client.publish('auto/save', '1'), 200); // small delay to allow messages to reach
}

/* ========== Local storage: save/load schedule & mode & batas ========= */
function saveScheduleToLocal(){
  const obj = { slots: {} };
  document.querySelectorAll('.sched-inp').forEach(inp=>{
    const t = inp.getAttribute('data-time');
    const led = inp.getAttribute('data-led');
    obj.slots[t] = obj.slots[t] || {};
    obj.slots[t][led] = parseInt(inp.value) || 0;
  });
  localStorage.setItem(LS_SCHEDULE, JSON.stringify(obj));
}
function loadScheduleFromLocal(){
  const raw = localStorage.getItem(LS_SCHEDULE);
  if(!raw) return false;
  try{
    const obj = JSON.parse(raw);
    document.querySelectorAll('.sched-inp').forEach(inp=>{
      const t = inp.getAttribute('data-time');
      const led = inp.getAttribute('data-led');
      if(obj.slots && obj.slots[t] && typeof obj.slots[t][led] !== 'undefined'){
        inp.value = obj.slots[t][led];
      }
    });
    return true;
  }catch(e){ console.warn('Load schedule local failed', e); return false; }
}
function saveModeToLocal(){ localStorage.setItem(LS_MODE, document.getElementById('modeSelect').value); }
function loadModeFromLocal(){ const m = localStorage.getItem(LS_MODE); if(m) document.getElementById('modeSelect').value = m; }

/* ========== On startup: load local schedule & mode & batas and sync to ESP ====== */
function loadLocalAndSyncToESP(){
  loadModeFromLocal();
  document.getElementById('modeSelect').dispatchEvent(new Event('change'));
  const had = loadScheduleFromLocal();
  const batas = localStorage.getItem(LS_BATAS);
  if(batas) document.getElementById('batasSuhu').value = batas;
  // if had schedule, publish to ESP so it has copy
  if(had){
    setTimeout(()=> publishFullScheduleToESP(), 500);
  }
}

/* ========== Mode select toggling UI (auto container visible always per request? we keep shown but sliders disabled in auto) ========== */
document.getElementById('modeSelect').addEventListener('change', ()=>{
  const isAuto = document.getElementById('modeSelect').value === 'auto';
  // show auto container (you asked always visible earlier; but we still show/hide to focus)
  // We'll keep shown but disable manual sliders if auto
  for(let i=1;i<=8;i++){
    document.getElementById('led'+i).disabled = isAuto;
    document.getElementById('led'+i+'-num').disabled = isAuto;
  }
  saveModeToLocal();
});

/* ========== Helper: load last saved state on page load ====== */
document.addEventListener('DOMContentLoaded', ()=>{
  loadLocalAndSyncToESP();
});

/* ========== For demo: pushChart with simulated values when no MQTT ====
   (you can remove this block if real MQTT provides suhu values) */
setInterval(()=>{
  // only push if no real data recently
  if(labels.length < 2){ pushChart(26 + Math.random(), 25 + Math.random()); }
}, 5000);
</script>
</body>
</html>
