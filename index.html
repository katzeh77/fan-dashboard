<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<title>LED Aquarium Controller</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
<script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
*{box-sizing:border-box}
body{
  margin:0;
  font-family:'Inter',sans-serif;
  background:url('https://images.unsplash.com/photo-1507525428034-b723cf961d3e?auto=format&fit=crop&w=1350&q=80') no-repeat center center fixed;
  background-size:cover;
  display:flex;
  flex-direction:column;
  align-items:center;
  min-height:100vh;
  padding:20px;
  color:#fff;
}
h1{margin:20px 0 10px;font-size:28px;text-align:center;text-shadow:2px 2px 6px rgba(0,0,0,0.7);}
#status{font-size:14px;color:#0f0;margin-bottom:10px;}
.dashboard{
  background:rgba(255,255,255,0.1);
  backdrop-filter:blur(15px);
  border-radius:20px;
  padding:25px;
  width:100%;
  max-width:480px;
  box-shadow:0 8px 24px rgba(0,0,0,0.4);
}
.temp-container{display:flex;justify-content:space-around;margin-bottom:20px;}
.temp-card{
  background:rgba(255,255,255,0.15);
  border-radius:12px;
  padding:15px 20px;
  text-align:center;
  min-width:120px;
}
.temp-value{font-size:24px;font-weight:600;margin-top:5px;}
.slider-container{margin:15px 0;text-align:left}
.slider-container label{display:block;font-weight:600;margin-bottom:5px;}
input[type=range]{width:100%;}
input[type=number]{width:60px;border-radius:6px;border:none;text-align:center;}
#alert-box{display:none;background:rgba(255,0,0,0.4);padding:10px;margin:10px 0;border-radius:10px;text-align:center;}
.section{
  background:rgba(255,255,255,0.12);
  padding:15px;
  border-radius:12px;
  margin-bottom:20px;
}
button{
  background:#007bff;
  color:#fff;
  border:none;
  border-radius:8px;
  padding:6px 14px;
  cursor:pointer;
  font-weight:600;
  margin:4px 0;
}
button:hover{background:#3399ff}
</style>
</head>

<body>
<h1>LED Aquarium Controller</h1>
<div id="status">ðŸ”Œ Menghubungkan ke MQTT...</div>

<div class="dashboard">

<!-- ===== MODE SECTION ===== -->
<div class="section">
  <h3>Mode Lampu</h3>
  <button onclick="setMode('manual')">Manual</button>
  <button onclick="setMode('auto')">Auto</button>
  <div>Status Mode: <b id="modeStatus">-</b></div>
</div>

<!-- ===== AUTO SETTINGS ===== -->
<div class="section">
  <h3>Pengaturan Mode Otomatis</h3>

  06.30-07.30 
  <input type="number" id="a1" min="0" max="100"> %
  <button onclick="setAuto(1)">Set</button><br><br>

  07.31-09.00 
  <input type="number" id="a2" min="0" max="100"> %
  <button onclick="setAuto(2)">Set</button><br><br>

  09.01-13.00 
  <input type="number" id="a3" min="0" max="100"> %
  <button onclick="setAuto(3)">Set</button><br><br>

  13.01-14.30 
  <input type="number" id="a4" min="0" max="100"> %
  <button onclick="setAuto(4)">Set</button><br><br>

  14.31-16.00 
  <input type="number" id="a5" min="0" max="100"> %
  <button onclick="setAuto(5)">Set</button>
</div>

<!-- ===== TEMPERATURE ===== -->
<div class="temp-container">
  <div class="temp-card">Atas<br><span id="temp1" class="temp-value">-- Â°C</span></div>
  <div class="temp-card">Bawah<br><span id="temp2" class="temp-value">-- Â°C</span></div>
</div>

<div id="alert-box"></div>

<!-- ===== LED CONTROLS ===== -->
<div id="led-controls"></div>

<!-- ===== BATAS SUHU ===== -->
<div class="section">
  <h3>Batas Suhu Maksimum</h3>
  <input type="number" id="batasSuhu" min="30" max="90" value="50"> Â°C
  <button id="setBatas">Simpan</button>
  <div id="batas-info" style="margin-top:8px;"></div>
</div>

<!-- ===== CHART ===== -->
<div class="section">
  <h3>Grafik Suhu Real-Time</h3>
  <canvas id="tempChart"></canvas>
</div>

</div>

<script>
// ===== MQTT =====
const client = mqtt.connect('wss://broker.emqx.io:8084/mqtt');
const ledNames = ["Royal Blue","Blue","Violet","Red","Green","White","Sump","Fan"];
const container = document.getElementById('led-controls');
const statusText = document.getElementById('status');

// ===== Create LED Sliders =====
ledNames.forEach((name,i)=>{
  const idx=i+1;
  container.innerHTML+=`
  <div class="slider-container">
    <label>${name}
    <input type="number" id="led${idx}-num" min="0" max="100" value="0">%</label>
    <input type="range" id="led${idx}" min="0" max="100" value="0">
  </div>`;
});

// ===== Chart =====
const ctx=document.getElementById('tempChart').getContext('2d');
const labels=[],data1=[],data2=[];
const tempChart=new Chart(ctx,{
type:'line',
data:{labels:labels,datasets:[
{label:'Atas',data:data1,borderColor:'red',fill:false},
{label:'Bawah',data:data2,borderColor:'cyan',fill:false}
]}
});

function updateChart(t1,t2){
 const now=new Date().toLocaleTimeString();
 labels.push(now);data1.push(t1);data2.push(t2);
 if(labels.length>60){labels.shift();data1.shift();data2.shift();}
 tempChart.update();
}

// ===== MQTT Events =====
client.on('connect',()=>{
 statusText.innerHTML="âœ… Terhubung ke MQTT";
 statusText.style.color="#0f0";

 for(let i=1;i<=8;i++) client.subscribe('led/'+i);
 client.subscribe('suhu/ntc1');
 client.subscribe('suhu/ntc2');
 client.subscribe('status/suhu');
 client.subscribe('status/batasSuhu');
 client.subscribe('status/mode');
});

client.on('message',(topic,message)=>{
 const msg=message.toString();

 if(topic==='status/mode'){
  document.getElementById('modeStatus').innerText=msg;
  disableManual(msg==="AUTO");
 }

 if(topic.startsWith('led/')){
  const num=parseInt(topic.split('/')[1]);
  const percent=Math.round(parseInt(msg)/255*100);
  document.getElementById('led'+num).value=percent;
  document.getElementById('led'+num+'-num').value=percent;
 }

 if(topic==='suhu/ntc1'){updateTemp('temp1',msg);updateChart(parseFloat(msg),data2[data2.length-1]||0);}
 if(topic==='suhu/ntc2'){updateTemp('temp2',msg);updateChart(data1[data1.length-1]||0,parseFloat(msg));}
 if(topic==='status/suhu') updateAlert(msg);
 if(topic==='status/batasSuhu') updateBatas(msg);
});

// ===== Functions =====
function setMode(mode){ client.publish('mode',mode); }

function setAuto(index){
 let val=parseInt(document.getElementById('a'+index).value);
 if(isNaN(val)) val=0;
 val=Math.min(100,Math.max(0,val));
 document.getElementById('a'+index).value=val;
 client.publish('auto/set'+index,Math.round(val*2.55).toString());
}

function disableManual(state){
 for(let i=1;i<=8;i++){
  document.getElementById('led'+i).disabled=state;
  document.getElementById('led'+i+'-num').disabled=state;
 }
}

function updateTemp(id,val){
 const el=document.getElementById(id);
 el.textContent=parseFloat(val).toFixed(1)+' Â°C';
}

function updateAlert(msg){
 const box=document.getElementById('alert-box');
 if(msg.startsWith('TINGGI')){
  box.innerHTML="âš ï¸ Suhu tinggi! LED dimatikan.";
  box.style.display='block';
 } else box.style.display='none';
}

function updateBatas(val){
 document.getElementById('batasSuhu').value=parseFloat(val).toFixed(1);
 document.getElementById('batas-info').innerText='Batas saat ini: '+val+' Â°C';
}

for(let i=1;i<=8;i++){
 const s=document.getElementById('led'+i);
 const n=document.getElementById('led'+i+'-num');
 s.addEventListener('input',()=>{
  n.value=s.value;
  client.publish('led/'+i,Math.round(s.value*2.55).toString());
 });
 n.addEventListener('change',()=>{
  let v=parseInt(n.value);
  if(isNaN(v))v=0;
  v=Math.min(100,Math.max(0,v));
  n.value=v;s.value=v;
  client.publish('led/'+i,Math.round(v*2.55).toString());
 });
}

document.getElementById('setBatas').addEventListener('click',()=>{
 const val=parseFloat(document.getElementById('batasSuhu').value);
 if(val>=30 && val<=90){
  client.publish('set/batasSuhu',val.toString());
  alert('Batas suhu dikirim: '+val+' Â°C');
 } else alert('Masukkan nilai 30â€“90 Â°C');
});
</script>

</body>
</html>
