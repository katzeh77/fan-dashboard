<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>LED Aquarium Controller</title>
<script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>

<h2>LED Aquarium Controller</h2>
<div id="status">Connecting...</div>

<h3>Mode</h3>
<button onclick="setMode('MANUAL')">Manual</button>
<button onclick="setMode('AUTO')">Auto</button>

<h3>Auto Max Level (11:00â€“12:30)</h3>
<div id="autoInputs"></div>
<button onclick="saveAuto()">Save</button>

<h3>LED Manual Control</h3>
<div id="leds"></div>

<h3>Suhu</h3>
Atas: <span id="t1">-</span><br>
Bawah: <span id="t2">-</span><br>
Batas: <input type="number" id="batas" value="50">
<button onclick="setBatas()">Set</button>

<canvas id="chart"></canvas>

<script>
const client = mqtt.connect('wss://broker.emqx.io:8084/mqtt');
const ledNames=["Royal Blue","Blue","Violet","Red","Green","White","Sump","Fan"];
let mode="MANUAL";

ledNames.forEach((n,i)=>{
 document.getElementById("leds").innerHTML+=
 n+` <input type="range" min="0" max="100" value="0"
 oninput="sendLED(${i+1},this.value)"><br>`;
 document.getElementById("autoInputs").innerHTML+=
 n+` <input type="number" id="auto${i}" value="100"><br>`;
});

function sendLED(ch,val){
 if(mode==="MANUAL")
   client.publish("led/"+ch,Math.round(val*2.55).toString());
}

function setMode(m){
 mode=m;
 client.publish("set/mode",m);
}

function saveAuto(){
 for(let i=0;i<8;i++){
   let v=document.getElementById("auto"+i).value;
   client.publish("set/autoMax/"+i,v);
 }
}

function setBatas(){
 let v=document.getElementById("batas").value;
 client.publish("set/batasSuhu",v);
}

client.on('connect',()=>{
 document.getElementById("status").innerHTML="Connected";
 client.subscribe("suhu/ntc1");
 client.subscribe("suhu/ntc2");
 client.subscribe("status/suhu");
});

let data1=[],data2=[],labels=[];
const ctx=document.getElementById('chart').getContext('2d');
new Chart(ctx,{
 type:'line',
 data:{labels:labels,
 datasets:[
 {label:'Atas',data:data1,borderColor:'red'},
 {label:'Bawah',data:data2,borderColor:'blue'}
 ]}
});

client.on('message',(topic,message)=>{
 let msg=message.toString();
 if(topic==="suhu/ntc1"){
   document.getElementById("t1").innerHTML=msg;
 }
 if(topic==="suhu/ntc2"){
   document.getElementById("t2").innerHTML=msg;
 }
});
</script>

</body>
</html>
