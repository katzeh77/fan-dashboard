<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>LED Aquarium Controller ‚Äî Final</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
<script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
/* === Gaya persis versi "ok bagus" (tidak dirubah) + beberapa kecil untuk indikator === */
*{box-sizing:border-box}
body{
  margin:0;
  font-family:'Inter',sans-serif;
  background:url('https://images.unsplash.com/photo-1507525428034-b723cf961d3e?auto=format&fit=crop&w=1350&q=80') no-repeat center center fixed;
  background-size:cover;
  display:flex;
  flex-direction:column;
  align-items:center;
  min-height:100vh;
  padding:20px;
  color:#fff;
}
h1{
  margin:10px 0 5px;
  font-size:28px;
  text-align:center;
  text-shadow:2px 2px 6px rgba(0,0,0,0.7);
}
#status{
  font-size:14px;
  color:#0f0;
  margin-bottom:10px;
  text-shadow:1px 1px 3px rgba(0,0,0,0.5);
}
.dashboard{
  background:rgba(255,255,255,0.1);
  backdrop-filter:blur(15px);
  border-radius:20px;
  padding:25px;
  width:100%;
  max-width:460px;
  box-shadow:0 8px 24px rgba(0,0,0,0.4);
}
.temp-container{
  display:flex;
  justify-content:space-around;
  margin-bottom:20px;
  flex-wrap:wrap;
}
.temp-card{
  background:rgba(255,255,255,0.15);
  border-radius:12px;
  padding:15px 20px;
  text-align:center;
  min-width:120px;
  margin:5px;
  box-shadow:0 4px 10px rgba(0,0,0,0.3);
  transition:background 0.3s;
}
.temp-value{
  font-size:24px;
  font-weight:600;
  margin-top:5px;
}
.slider-container{margin:12px 0 6px 0;text-align:left}
.slider-row{display:flex;justify-content:space-between;align-items:center;gap:8px;flex-wrap:wrap}
.slider-left{flex:1 1 60%}
.slider-right{width:80px;text-align:center}
.slider-label{display:flex;align-items:center;gap:8px}
input[type=range]{
  -webkit-appearance:none;
  width:100%;
  height:12px;
  border-radius:6px;
  background:rgba(255,255,255,0.3);
  outline:none;
}
input[type=range]::-webkit-slider-thumb{
  -webkit-appearance:none;
  width:24px;
  height:24px;
  border-radius:50%;
  background:#fff;
  border:2px solid #007bff;
  cursor:pointer;
}
input[type=number]{
  width:60px;
  border:none;
  border-radius:8px;
  text-align:center;
  padding:5px;
  background:rgba(255,255,255,0.2);
  color:#fff;
}
#alert-box{
  display:none;
  background:rgba(255,0,0,0.4);
  padding:10px;
  margin:10px 0;
  border-radius:10px;
  text-align:center;
  font-weight:600;
}
#batas-container{
  background:rgba(255,255,255,0.15);
  border-radius:12px;
  padding:15px;
  margin-top:15px;
  box-shadow:0 4px 10px rgba(0,0,0,0.3);
}
button{
  background:#007bff;
  color:#fff;
  border:none;
  border-radius:8px;
  padding:6px 14px;
  cursor:pointer;
  font-weight:600;
}
button:hover{background:#3399ff}
#chart-container{
  margin-top:25px;
  background:rgba(255,255,255,0.1);
  padding:15px;
  border-radius:15px;
  box-shadow:0 4px 10px rgba(0,0,0,0.3);
}
/* Mode toggle */
.mode-select{
  margin-bottom:12px;
  text-align:center;
}
#auto-container{
  background:rgba(255,255,255,0.15);
  border-radius:12px;
  padding:12px;
  margin-top:12px;
  display:none;
  box-shadow:0 4px 10px rgba(0,0,0,0.3);
  max-height:320px;
  overflow:auto;
}
#clock{
  text-align:center;
  font-size:18px;
  font-weight:600;
  margin-bottom:10px;
  text-shadow:1px 1px 2px rgba(0,0,0,0.6);
}
.schedule-table{
  width:100%;
  border-collapse:collapse;
  color:#fff;
  font-size:13px;
}
.schedule-table th,.schedule-table td{
  border-bottom:1px solid rgba(255,255,255,0.2);
  padding:6px 6px;
  text-align:center;
}
.indicator {
  width:12px; height:12px; border-radius:50%; display:inline-block;
  box-shadow:0 0 4px rgba(0,0,0,0.6);
  border:2px solid rgba(255,255,255,0.15);
}
.ind-off { background:rgba(200,200,200,0.2); }
.ind-on { background:#00ff7f; } /* green when active */
.ind-warn { background:#ffd24d; } /* yellow for low */
.small-note{font-size:12px;color:#ddd;margin-top:6px}

/* small responsive tweaks */
@media (max-width:768px){
  body{padding:10px;font-size:14px}
  .dashboard{width:100%;padding:15px}
  .schedule-table{font-size:12px}
  input[type=range]{width:90%}
  canvas{width:100%!important;height:auto!important}
}
</style>
</head>
<body>
<h1>LED Aquarium Controller</h1>
<div id="status">üîå Menghubungkan ke MQTT...</div>

<div class="dashboard">
  <div class="mode-select">
    <label style="font-weight:600">Pilih Mode: </label>
    <select id="modeSelect" style="margin-left:8px;padding:6px;border-radius:8px;">
      <option value="manual">Manual</option>
      <option value="auto">Otomatis</option>
    </select>
    <div class="small-note" id="modeNote">Mode tersimpan: ‚Äî</div>
  </div>

  <div class="temp-container">
    <div class="temp-card">Atas<br><span id="temp1" class="temp-value">-- ¬∞C</span></div>
    <div class="temp-card">Bawah<br><span id="temp2" class="temp-value">-- ¬∞C</span></div>
  </div>

  <div id="alert-box"></div>

  <!-- manual sliders (ke-8) -->
  <div id="led-controls"></div>

  <!-- auto area (clock + schedule table + buttons) -->
  <div id="auto-container" aria-live="polite">
    <div id="clock">--:--:--</div>
    <h3 style="text-align:center;margin-bottom:8px;">Jadwal Intensitas Otomatis</h3>
    <div style="overflow-x:auto;">
      <table class="schedule-table" id="scheduleTable" aria-label="Jadwal Otomatis">
        <thead>
          <tr>
            <th>Waktu</th>
            <th>Royal Blue</th><th>Blue</th><th>Violet</th><th>Red</th>
            <th>Green</th><th>White</th><th>Sump</th><th>Fan</th>
          </tr>
        </thead>
        <tbody id="schedule-body"></tbody>
      </table>
    </div>
    <div style="display:flex;gap:8px;margin-top:10px;">
      <button id="startAuto" style="flex:1">‚ñ∂Ô∏è Start Otomatis</button>
      <button id="saveAll" style="flex:1;background:#22a6b3">üíæ Simpan Semua</button>
    </div>
  </div>

  <div id="batas-container">
    <h3>Batas Suhu Maksimum</h3>
    <input type="number" id="batasSuhu" min="30" max="90" value="50"> ¬∞C
    <button id="setBatas">Simpan</button>
    <div id="batas-info" style="margin-top:8px;color:#ddd;font-size:14px;"></div>
  </div>

  <div id="chart-container">
    <h3 style="text-align:center;margin-bottom:10px;">Grafik Suhu Real-Time</h3>
    <canvas id="tempChart" width="400" height="200"></canvas>
  </div>
</div>

<script>
/* =======================
   CONFIG & STATE
   ======================= */
const MQTT_BROKER = 'wss://broker.emqx.io:8084/mqtt'; // ganti kalau perlu
const client = mqtt.connect(MQTT_BROKER);
const ledNames = ["Royal Blue","Blue","Violet","Red","Green","White","Sump","Fan"];

// build scheduleTimes 07:00..16:00 step 30m => 19 slots
const scheduleTimes = [];
for (let h=7; h<=16; h++){
  scheduleTimes.push(`${String(h).padStart(2,'0')}:00`);
  if (h < 16) scheduleTimes.push(`${String(h).padStart(2,'0')}:30`);
}

/* storage keys */
const KEY_SCHEDULE = 'led_schedule';
const KEY_MODE = 'led_mode';
const KEY_SLIDERS = 'led_sliders';
const KEY_BATAS = 'batas_suhu';

/* helpers localStorage */
function saveToStorage(k, v){ try{ localStorage.setItem(k, JSON.stringify(v)); }catch(e){console.warn(e);} }
function loadFromStorage(k, def){ try{ const s = localStorage.getItem(k); return s?JSON.parse(s):def; }catch(e){return def;} }

/* =======================
   UI BUILD
   ======================= */
/* sliders */
const ledControls = document.getElementById('led-controls');
ledNames.forEach((name, i) => {
  const idx = i + 1;
  const div = document.createElement('div');
  div.className = 'slider-container';
  div.innerHTML = `
    <div class="slider-row">
      <div class="slider-label slider-left">
        <span style="min-width:140px;display:inline-block;font-weight:600">${name}</span>
        <span id="ind-${idx}" class="indicator ind-off" title="Status LED ${idx}" style="margin-left:6px;"></span>
      </div>
      <div class="slider-right">
        <input id="led${idx}-num" type="number" min="0" max="100" value="0">%
      </div>
    </div>
    <div style="margin-top:8px;"><input id="led${idx}" type="range" min="0" max="100" value="0"></div>
  `;
  ledControls.appendChild(div);
});

/* schedule table */
const scheduleBody = document.getElementById('schedule-body');
scheduleTimes.forEach(time => {
  const token = time.replace(':','-');
  const tr = document.createElement('tr');
  let html = `<td style="font-weight:600">${time}</td>`;
  for (let i=1;i<=8;i++){
    html += `<td><input id="auto-${token}-${i}" type="number" min="0" max="100" value="0" style="width:64px;text-align:center;background:rgba(255,255,255,0.06);border-radius:6px;color:#fff;border:1px solid rgba(255,255,255,0.06);"></td>`;
  }
  tr.innerHTML = html;
  scheduleBody.appendChild(tr);
});

/* =======================
   Load saved state
   ======================= */
const savedSchedule = loadFromStorage(KEY_SCHEDULE, {});
const savedMode = loadFromStorage(KEY_MODE, 'manual');
const savedSliders = loadFromStorage(KEY_SLIDERS, {});
const savedBatas = loadFromStorage(KEY_BATAS, null);

/* apply saved batas */
if (savedBatas !== null){
  document.getElementById('batasSuhu').value = savedBatas;
  document.getElementById('batas-info').innerText = 'Batas suhu saat ini: ' + savedBatas + ' ¬∞C';
}

/* apply saved sliders */
for (let i=1;i<=8;i++){
  const s = document.getElementById('led'+i);
  const n = document.getElementById('led'+i+'-num');
  const val = (savedSliders[i] !== undefined) ? savedSliders[i] : 0;
  if (s) s.value = val;
  if (n) n.value = val;
}

/* populate schedule table from savedSchedule */
scheduleTimes.forEach(time => {
  const token = time.replace(':','-');
  const arr = savedSchedule[time] || Array(8).fill(0);
  for (let i=1;i<=8;i++){
    const inp = document.getElementById(`auto-${token}-${i}`);
    if (inp) inp.value = arr[i-1];
  }
});

/* === set mode UI from saved === */
const modeSelect = document.getElementById('modeSelect');
modeSelect.value = savedMode;
document.getElementById('modeNote').textContent = `Mode tersimpan: ${savedMode.toUpperCase()}`;

/* =======================
   MQTT connection & handlers
   ======================= */
const statusEl = document.getElementById('status');
client.on('connect', () => {
  statusEl.innerHTML = '‚úÖ Terhubung ke broker MQTT';
  statusEl.style.color = '#0f0';
  // subscribe
  for (let i=1;i<=8;i++) client.subscribe(`led/${i}`);
  client.subscribe('suhu/ntc1');
  client.subscribe('suhu/ntc2');
  client.subscribe('status/suhu');
  client.subscribe('status/batasSuhu');
  client.subscribe('mode/status');
  // if mode is auto, apply current slot
  if (loadFromStorage(KEY_MODE,'manual') === 'auto') applyCurrentScheduleSlot(true);
});
client.on('reconnect', ()=>{ statusEl.innerHTML='‚ôªÔ∏è Menghubungkan ulang...'; statusEl.style.color='#ff0'; });
client.on('offline', ()=>{ statusEl.innerHTML='‚ùå Terputus dari MQTT'; statusEl.style.color='#f00'; });

client.on('message', (topic, message) => {
  const msg = message.toString();
  if (topic.startsWith('led/')) {
    const num = parseInt(topic.split('/')[1]);
    const percent = Math.round(parseInt(msg) / 255 * 100);
    const s = document.getElementById('led'+num);
    const n = document.getElementById('led'+num+'-num');
    if (s) s.value = percent;
    if (n) n.value = percent;
    // indicator: if >0 green else off
    const ind = document.getElementById(`ind-${num}`);
    if (ind) ind.className = 'indicator ' + (percent > 0 ? 'ind-on' : 'ind-off');
    // save slider state
    const sliders = loadFromStorage(KEY_SLIDERS, {});
    sliders[num] = percent;
    saveToStorage(KEY_SLIDERS, sliders);
  }
  if (topic === 'suhu/ntc1') { updateTemp('temp1', msg); updateChart(parseFloat(msg), null); }
  if (topic === 'suhu/ntc2') { updateTemp('temp2', msg); updateChart(null, parseFloat(msg)); }
  if (topic === 'status/suhu') updateAlert(msg);
  if (topic === 'status/batasSuhu') updateBatas(msg);
  if (topic === 'mode/status') {
    // optional: if ESP reports mode status
    document.getElementById('modeNote').textContent = `Mode ESP: ${msg}`;
  }
});

/* =======================
   Chart
   ======================= */
const ctx = document.getElementById('tempChart').getContext('2d');
const labels = [], d1 = [], d2 = [];
const tempChart = new Chart(ctx, {
  type: 'line',
  data: {
    labels,
    datasets: [
      { label: 'Atas', data: d1, borderColor: 'rgba(255,99,132,1)', tension:0.3, fill:false },
      { label: 'Bawah', data: d2, borderColor: 'rgba(54,162,235,1)', tension:0.3, fill:false }
    ]
  },
  options: { scales: { y: { min: 20, max: 70 } }, plugins:{legend:{labels:{color:'#fff'}}} }
});
function updateChart(a,b){
  const now = new Date().toLocaleTimeString();
  labels.push(now);
  d1.push(a === null ? (d1.length ? d1[d1.length-1] : null) : a);
  d2.push(b === null ? (d2.length ? d2[d2.length-1] : null) : b);
  if (labels.length > 60){ labels.shift(); d1.shift(); d2.shift(); }
  tempChart.update();
}

/* =======================
   UI & Storage interactions
   ======================= */
/* schedule cell change -> save local + publish auto/set/<time>/<led> */
scheduleTimes.forEach(time => {
  const token = time.replace(':','-');
  for (let i=1;i<=8;i++){
    const inp = document.getElementById(`auto-${token}-${i}`);
    if (!inp) continue;
    inp.addEventListener('change', () => {
      let v = parseInt(inp.value); if (isNaN(v)) v = 0; v = Math.max(0, Math.min(100, v));
      inp.value = v;
      const sched = loadFromStorage(KEY_SCHEDULE, {});
      if (!sched[time]) sched[time] = Array(8).fill(0);
      sched[time][i-1] = v;
      saveToStorage(KEY_SCHEDULE, sched);
      // publish per-cell
      const payload = Math.round(v * 2.55);
      if (client.connected) client.publish(`auto/set/${time}/${i}`, String(payload));
    });
  }
});

/* sliders: save on change; publish only in manual mode */
for (let i=1;i<=8;i++){
  const s = document.getElementById('led'+i);
  const n = document.getElementById('led'+i+'-num');
  if (!s || !n) continue;
  s.addEventListener('input', ()=>{
    n.value = s.value;
    const sliders = loadFromStorage(KEY_SLIDERS, {});
    sliders[i] = parseInt(s.value);
    saveToStorage(KEY_SLIDERS, sliders);
    const mode = loadFromStorage(KEY_MODE, 'manual');
    if (mode === 'manual' && client.connected) client.publish(`led/${i}`, String(Math.round(s.value * 2.55)));
  });
  n.addEventListener('change', ()=>{
    let v = parseInt(n.value); if (isNaN(v)) v=0; v = Math.max(0, Math.min(100, v));
    n.value = v; s.value = v;
    const sliders = loadFromStorage(KEY_SLIDERS, {});
    sliders[i] = parseInt(v);
    saveToStorage(KEY_SLIDERS, sliders);
    const mode = loadFromStorage(KEY_MODE, 'manual');
    if (mode === 'manual' && client.connected) client.publish(`led/${i}`, String(Math.round(v * 2.55)));
  });
}

/* mode select */
function applyModeUI(mode){
  document.getElementById('auto-container').style.display = (mode==='auto') ? 'block' : 'none';
  document.getElementById('led-controls').style.display = (mode==='manual') ? 'block' : 'none';
  for (let i=1;i<=8;i++){
    const s = document.getElementById('led'+i);
    const n = document.getElementById('led'+i+'-num');
    if (s) s.disabled = (mode !== 'manual');
    if (n) n.disabled = (mode !== 'manual');
  }
  document.getElementById('modeNote').textContent = `Mode tersimpan: ${mode.toUpperCase()}`;
}
applyModeUI(modeSelect.value);
modeSelect.addEventListener('change', ()=>{
  const mode = modeSelect.value;
  saveToStorage(KEY_MODE, mode);
  applyModeUI(mode);
  // if switching to auto, apply current slot immediately
  if (mode === 'auto') {
    applyCurrentScheduleSlot(true);
    if (client.connected) client.publish('mode/set','auto');
  } else {
    if (client.connected) client.publish('mode/set','manual');
  }
});

/* batas suhu */
document.getElementById('setBatas').addEventListener('click', ()=>{
  const val = parseFloat(document.getElementById('batasSuhu').value);
  if (isNaN(val) || val < 30 || val > 90){ alert('Masukkan nilai antara 30‚Äì90 ¬∞C'); return; }
  saveToStorage(KEY_BATAS, val);
  document.getElementById('batas-info').innerText = 'Batas suhu saat ini: ' + val + ' ¬∞C';
  if (client.connected) client.publish('set/batasSuhu', String(val));
});

/* Save All button (batch send all schedule cells) */
document.getElementById('saveAll').addEventListener('click', ()=>{
  const sched = {};
  scheduleTimes.forEach(time => {
    const token = time.replace(':','-');
    const arr = [];
    for (let i=1;i<=8;i++){
      const inp = document.getElementById(`auto-${token}-${i}`);
      const v = inp ? Math.max(0, Math.min(100, parseInt(inp.value) || 0)) : 0;
      arr.push(v);
      // publish each cell
      if (client.connected) client.publish(`auto/set/${time}/${i}`, String(Math.round(v * 2.55)));
    }
    sched[time] = arr;
  });
  saveToStorage(KEY_SCHEDULE, sched);
  alert('Semua jadwal disimpan dan dikirim ke ESP (auto/set/*).');
});

/* Start Auto button */
document.getElementById('startAuto').addEventListener('click', ()=>{
  applyCurrentScheduleSlot(true);
  if (client.connected) client.publish('auto/start','1');
  alert('Mode otomatis dimulai dan jadwal saat ini diterapkan.');
});

/* Sync time button (optional) - publish ISO timestamp */
(function addSyncTimeBtn(){
  const btn = document.createElement('button');
  btn.textContent = '‚è≤Ô∏è Sync Time';
  btn.style.marginTop = '8px';
  btn.addEventListener('click', ()=>{
    const nowISO = new Date().toISOString();
    if (client.connected) {
      client.publish('time/set', nowISO);
      alert('Waktu dikirim ke ESP: ' + nowISO);
    } else alert('MQTT tidak terhubung.');
  });
  document.getElementById('auto-container').appendChild(btn);
})();

/* =======================
   Schedule apply logic
   ======================= */
let lastPublishedSlot = null;
let lastMinuteChecked = null;

/* helper: get current slot as HH:MM string (rounded to 00 or 30) */
function getCurrentSlot(){
  const now = new Date();
  const h = now.getHours();
  const m = now.getMinutes();
  if (h < 7 || h > 16) return null;
  const mm = (m < 30) ? '00' : '30';
  const slot = `${String(h).padStart(2,'0')}:${mm}`;
  return scheduleTimes.includes(slot) ? slot : null;
}

/* publish slot values to led/1..led/8 */
function publishSlot(slotTime){
  const sched = loadFromStorage(KEY_SCHEDULE, {});
  const arr = sched[slotTime] || Array(8).fill(0);
  for (let i=1;i<=8;i++){
    const pct = arr[i-1] || 0;
    const payload = String(Math.round(pct * 2.55));
    if (client.connected) client.publish(`led/${i}`, payload);
  }
  // update UI sliders to reflect commanded values (and storage)
  const sliders = loadFromStorage(KEY_SLIDERS, {});
  for (let i=1;i<=8;i++){
    const v = arr[i-1] || 0;
    const s = document.getElementById('led'+i);
    const n = document.getElementById('led'+i+'-num');
    if (s) s.value = v;
    if (n) n.value = v;
    sliders[i] = v;
  }
  saveToStorage(KEY_SLIDERS, sliders);
  lastPublishedSlot = slotTime;
}

/* apply current slot if in auto mode (force=true to override lastPublishedSlot) */
function applyCurrentScheduleSlot(force=false){
  const mode = loadFromStorage(KEY_MODE,'manual');
  if (mode !== 'auto') return;
  const slot = getCurrentSlot();
  if (!slot) return;
  if (!force && slot === lastPublishedSlot) return;
  publishSlot(slot);
}

/* periodic checker - run every 10 seconds, but act only when minute changes and minute %30 ==0 */
setInterval(()=>{
  const now = new Date();
  const minute = now.getMinutes();
  if (minute === lastMinuteChecked) return;
  lastMinuteChecked = minute;
  if (minute % 30 !== 0) return;
  const mode = loadFromStorage(KEY_MODE,'manual');
  if (mode === 'auto') applyCurrentScheduleSlot(false);
}, 10000);

/* on load apply mode & if auto apply current slot immediately */
window.addEventListener('load', ()=>{
  const m = loadFromStorage(KEY_MODE,'manual');
  modeSelect.value = m;
  applyModeUI(m);
  if (m === 'auto') applyCurrentScheduleSlot(true);
});

/* =======================
   Utility UI functions (duplicated small ones)
   ======================= */
function updateTemp(id,val){
  if (!val && val !== 0) return;
  const t = parseFloat(val).toFixed(1);
  const el = document.getElementById(id);
  if (el) el.textContent = t + ' ¬∞C';
  const card = el ? el.parentElement : null;
  if (card){
    if (t >= 50) card.style.background = 'rgba(255,0,0,0.4)';
    else if (t >= 40) card.style.background = 'rgba(255,215,0,0.3)';
    else card.style.background = 'rgba(255,255,255,0.15)';
  }
}
function updateAlert(msg){
  const box = document.getElementById('alert-box');
  if (msg && msg.startsWith('TINGGI')) {
    const suhu = msg.split(':')[1] || '';
    box.innerHTML = `‚ö†Ô∏è Suhu tinggi: ${suhu} ¬∞C<br>Semua LED dimatikan.`;
    box.style.display = 'block';
  } else box.style.display = 'none';
}
function updateBatas(val){
  if (val === undefined || val === null) return;
  document.getElementById('batasSuhu').value = parseFloat(val).toFixed(1);
  document.getElementById('batas-info').innerText = 'Batas suhu saat ini: ' + val + ' ¬∞C';
}

/* ensure schedule keys exist in storage */
(function ensureScheduleInit(){
  const sched = loadFromStorage(KEY_SCHEDULE, {});
  let changed = false;
  scheduleTimes.forEach(t => { if (!sched[t]) { sched[t] = Array(8).fill(0); changed = true; } });
  if (changed) saveToStorage(KEY_SCHEDULE, sched);
})();
</script>
</body>
</html>
