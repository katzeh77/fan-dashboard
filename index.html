<!DOCTYPE html>
<html>
<head>
<title>Reef Controller</title>
<script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>

<body style="background:#111;color:white;font-family:Arial;padding:20px">

<h2>Reef LED Controller</h2>

<button onclick="setMode('MANUAL')">Manual</button>
<button onclick="setMode('AUTO')">Auto</button>
<p id="modeStatus">Mode: MANUAL</p>

<div id="sliders"></div>

<h3>Auto Max Level</h3>
<div id="autoLevels"></div>

<h3>Suhu</h3>
<p>Atas: <span id="tempTop">0</span> °C</p>
<p>Bawah: <span id="tempBottom">0</span> °C</p>

<input type="number" id="maxTemp" value="30">
<button onclick="setMaxTemp()">Set Max Temp</button>

<canvas id="tempChart"></canvas>

<script>

const client = mqtt.connect("wss://broker.hivemq.com:8884/mqtt");
let mode="MANUAL";

const ledNames=["RB","B","W","R","G","UV","CH7","CH8"];

const sliders=document.getElementById("sliders");
const autoDiv=document.getElementById("autoLevels");

ledNames.forEach((n,i)=>{
  sliders.innerHTML+=`
  <div>
    ${n}
    <input type="range" min="0" max="100" value="0"
      oninput="setLED(${i},this.value)">
  </div>`;
  
  autoDiv.innerHTML+=`
  <div>
    ${n}
    <input type="number" min="0" max="100" value="100"
      onchange="setAuto(${i},this.value)">
  </div>`;
});

function setLED(ch,val){
  client.publish("reef/led/"+ch,val);
}

function setAuto(ch,val){
  client.publish("reef/auto/"+ch,val);
}

function setMode(m){
  mode=m;
  client.publish("reef/mode",m);
  document.getElementById("modeStatus").innerText="Mode: "+m;
}

function setMaxTemp(){
  let v=document.getElementById("maxTemp").value;
  client.publish("reef/maxTemp",v);
}

client.on("connect",()=>{
  client.subscribe("reef/#");
});

client.on("message",(topic,msg)=>{
  let data=msg.toString();

  if(topic=="reef/temp/top"){
    document.getElementById("tempTop").innerText=data;
    addChart(parseFloat(data));
  }
  if(topic=="reef/temp/bottom"){
    document.getElementById("tempBottom").innerText=data;
  }
});

// ===== CHART =====
const ctx=document.getElementById("tempChart");
const chart=new Chart(ctx,{
  type:'line',
  data:{
    labels:[],
    datasets:[{
      label:'Suhu Atas',
      data:[],
      borderColor:'cyan'
    }]
  }
});

function addChart(val){
  let time=new Date().toLocaleTimeString();
  chart.data.labels.push(time);
  chart.data.datasets[0].data.push(val);
  if(chart.data.labels.length>20){
    chart.data.labels.shift();
    chart.data.datasets[0].data.shift();
  }
  chart.update();
}

</script>
</body>
</html>
