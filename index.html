<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<title>LED Aquarium Controller</title>
<script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
<style>
body{font-family:sans-serif;background:#111;color:#fff;text-align:center;padding:20px}
.dashboard{background:#222;padding:20px;border-radius:15px;max-width:450px;margin:auto}
.slider-container{margin:15px 0;text-align:left}
input[type=range]{width:100%}
input[type=number]{width:60px}
.temp-card{display:inline-block;background:#333;padding:15px 20px;margin:5px;border-radius:10px}
.temp-value{font-size:22px;font-weight:600}
#alert-box{display:none;background:#c00;padding:10px;margin:10px 0;border-radius:8px}
#batas-container{margin-top:20px;background:#333;padding:10px;border-radius:10px}
</style>
</head>
<body>
<h1>LED Aquarium Controller</h1>
<div class="dashboard">
  <div class="temp-card">Atas<br><span id="temp1" class="temp-value">-- °C</span></div>
  <div class="temp-card">Bawah<br><span id="temp2" class="temp-value">-- °C</span></div>
  <div id="alert-box"></div>

  <div id="led-controls"></div>

  <div id="batas-container">
    <h3>Batas Suhu Maksimum</h3>
    <input type="number" id="batasSuhu" min="30" max="90" value="50"> °C
    <button id="setBatas">Simpan</button>
    <div id="batas-info" style="margin-top:8px;color:#ccc;font-size:14px;"></div>
  </div>
</div>

<script>
const client=mqtt.connect('wss://broker.emqx.io:8084/mqtt');
const ledNames=["Royal Blue","Blue","Violet","Red","Green","White","Sump","Fan"];
const container=document.getElementById('led-controls');

ledNames.forEach((n,i)=>{
  const idx=i+1;
  container.innerHTML+=`
  <div class="slider-container">
    <label>${n} <input type="number" id="led${idx}-num" min="0" max="100" value="0">%</label>
    <input type="range" id="led${idx}" min="0" max="100" value="0">
  </div>`;
});

client.on('connect',()=>{
  console.log("Connected MQTT");
  for(let i=1;i<=8;i++) client.subscribe('led/'+i);
  client.subscribe('suhu/ntc1');
  client.subscribe('suhu/ntc2');
  client.subscribe('status/suhu');
  client.subscribe('status/batasSuhu');
});

client.on('message',(topic,message)=>{
  const msg=message.toString();
  if(topic.startsWith('led/')){
    const num=parseInt(topic.split('/')[1]);
    const percent=Math.round(parseInt(msg)/255*100);
    document.getElementById('led'+num).value=percent;
    document.getElementById('led'+num+'-num').value=percent;
  }
  if(topic==='suhu/ntc1') document.getElementById('temp1').textContent=parseFloat(msg).toFixed(1)+' °C';
  if(topic==='suhu/ntc2') document.getElementById('temp2').textContent=parseFloat(msg).toFixed(1)+' °C';
  if(topic==='status/suhu') updateAlert(msg);
  if(topic==='status/batasSuhu') updateBatas(msg);
});

for(let i=1;i<=8;i++){
  const s=document.getElementById('led'+i);
  const n=document.getElementById('led'+i+'-num');
  s.addEventListener('input',()=>{
    n.value=s.value;
    client.publish('led/'+i,Math.round(s.value*2.55).toString());
  });
  n.addEventListener('change',()=>{
    let v=parseInt(n.value);
    if(isNaN(v))v=0;
    v=Math.min(100,Math.max(0,v));
    n.value=v;s.value=v;
    client.publish('led/'+i,Math.round(v*2.55).toString());
  });
}

function updateAlert(msg){
  const box=document.getElementById('alert-box');
  if(msg.startsWith('TINGGI')){
    const suhu=msg.split(':')[1];
    box.innerHTML=`⚠️ Suhu tinggi: ${suhu} °C<br>Semua LED dimatikan.`;
    box.style.display='block';
  }else box.style.display='none';
}

function updateBatas(val){
  document.getElementById('batasSuhu').value=parseFloat(val).toFixed(1);
  document.getElementById('batas-info').innerText='Batas suhu saat ini: '+val+' °C';
}

document.getElementById('setBatas').addEventListener('click',()=>{
  const val=parseFloat(document.getElementById('batasSuhu').value);
  if(val>=30 && val<=90){
    client.publish('set/batasSuhu',val.toString());
    alert('Batas suhu dikirim ke ESP32: '+val+' °C');
  }else{
    alert('Masukkan nilai antara 30–90 °C');
  }
});
</script>
</body>
</html>
